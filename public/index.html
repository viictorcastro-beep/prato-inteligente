<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Prato Inteligente 3.0 | Karolline Martins</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%232E7D32%22/></svg>">

    <!-- Google Fonts e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        :root {
            --primary-green: #2E7D32;
            --secondary-green: #4CAF50;
            --accent-orange: #FF7043;
            --accent-orange-hover: #F4511E;
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --bg-light-gray: #f0f2f5;
            --border-color: #e0e0e0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light-gray);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
        }

        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--text-light);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--text-light);
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        header h1 {
            margin: 0;
            font-size: 2.8rem;
            position: relative;
        }
        
        header p {
            margin: 10px 0 0;
            font-size: 1.2rem;
            opacity: 0.9;
            position: relative;
        }

        main {
            display: flex;
            flex-wrap: wrap;
        }

        .food-selection {
            width: 60%;
            padding: 30px;
            border-right: 1px solid var(--border-color);
        }
        
        .your-plate {
            width: 40%;
            padding: 30px;
            background-color: #f8f9fa;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-green);
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-orange);
            padding-bottom: 10px;
        }
        
        .food-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #search-food {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .category-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            background-color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .tab-btn.active, .tab-btn:hover {
            background-color: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .food-item {
            background: var(--text-light);
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .food-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        .food-item i {
            font-size: 2.5rem;
            color: var(--primary-green);
        }
        
        .food-item span {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        #plate-items {
            list-style: none;
            padding: 0;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        #plate-items li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            margin-bottom: 10px;
            animation: fadeIn 0.3s;
        }
        
        .item-details {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .item-details span:first-child { font-weight: 600; flex-basis: 100%;}

        .item-details input {
            width: 70px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
        }
        
        .item-details select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #d9534f;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .total-carbs {
            margin-top: 30px;
            text-align: center;
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
        }

        .total-carbs h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-dark);
        }
        
        #total-carbs-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-green);
            transition: color 0.3s;
        }
        
        .carbs-level-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            height: 10px;
            margin-top: 10px;
        }
        
        #carbs-level-bar {
            width: 0%;
            height: 100%;
            border-radius: 5px;
            background-color: var(--secondary-green);
            transition: width 0.5s, background-color 0.5s;
        }
        
        #feedback-message {
            margin-top: 10px;
            font-weight: 600;
            min-height: 20px;
        }
        
        .plate-actions {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #clear-plate-btn {
            background-color: #777;
            color: white;
        }
        #clear-plate-btn:hover {
            background-color: #555;
        }

        #analyze-btn {
            background-color: var(--accent-orange);
            color: white;
            font-size: 1.1rem;
        }
        #analyze-btn:hover {
            background-color: var(--accent-orange-hover);
        }
        #analyze-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* --- Seção de Análise da IA --- */
        #ai-analysis-section {
            display: none;
            padding: 30px;
            background-color: #f8f9fa;
            animation: fadeIn 0.5s;
        }
        #ai-analysis-section h2 {
            text-align: center;
        }
        
        .analysis-content {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            text-align: left;
        }

        .analysis-content h3 {
            color: var(--primary-green);
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .analysis-content p {
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .final-cta {
            margin-top: 30px;
            padding: 20px;
            background-color: #e8f5e9;
            border-radius: 10px;
            text-align: center;
        }

        .final-cta p {
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* Responsividade */
        @media (max-width: 992px) {
            main {
                flex-direction: column;
            }
            .food-selection, .your-plate {
                width: 100%;
                border-right: none;
            }
            .your-plate {
                border-top: 1px solid var(--border-color);
            }
        }
        
        @media (max-width: 576px) {
            body { padding: 10px; }
            header h1 { font-size: 2rem; }
            .food-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }

    </style>
</head>
<body>

    <div class="calculator-container">
        <header>
            <h1>Calculadora de Prato Inteligente 3.0</h1>
            <p>Monte sua refeição, controle os carboidratos e conquiste sua saúde!</p>
        </header>
        <main>
            <section class="food-selection">
                <h2><i class="fas fa-utensils"></i> Monte sua Refeição</h2>
                <div class="food-controls">
                    <input type="text" id="search-food" placeholder="🔎 Pesquisar alimento...">
                </div>
                <div class="category-tabs" id="category-tabs">
                    <!-- Abas de categoria serão inseridas aqui -->
                </div>
                <div class="food-grid" id="food-grid">
                    <!-- Alimentos serão inseridos aqui via JS -->
                </div>
            </section>
            <aside class="your-plate">
                <h2><i class="fas fa-drumstick-bite"></i> Seu Prato</h2>
                <ul id="plate-items">
                    <li id="empty-plate-message">Seu prato está vazio.</li>
                </ul>
                <div class="total-carbs">
                    <h3>Total de Carboidratos</h3>
                    <span id="total-carbs-value">0.0</span>g
                    <div class="carbs-level-bar-container">
                        <div id="carbs-level-bar"></div>
                    </div>
                    <div id="feedback-message"></div>
                </div>
                <div class="plate-actions">
                    <button id="analyze-btn" class="action-button"><i class="fas fa-magic"></i> Analisar Refeição com IA</button>
                    <button id="clear-plate-btn" class="action-button">Limpar Prato</button>
                </div>
            </aside>
        </main>
        <section id="ai-analysis-section">
            <h2><i class="fas fa-robot"></i> Análise da sua Refeição</h2>
            <div id="analysis-result" class="analysis-content">
                <!-- Resultado da IA será inserido aqui -->
            </div>
        </section>
    </div>

    <script>
        // --- BASE DE DADOS DE ALIMENTOS EXPANDIDA ---
        const foodDatabase = [
            // name, category, icon, carbsPer100g, unitName, unitWeight, defaultQty (em unitName)
            // Cereais, Grãos e Pães
            { name: 'Arroz branco', category: 'Cereais e Grãos', icon: 'fas fa-utensils', carbsPer100g: 28, unitName: 'colher de sopa', unitWeight: 25, defaultQty: 4 },
            { name: 'Arroz integral', category: 'Cereais e Grãos', icon: 'fas fa-utensils', carbsPer100g: 25, unitName: 'colher de sopa', unitWeight: 25, defaultQty: 4 },
            { name: 'Pão Francês', category: 'Cereais e Grãos', icon: 'fas fa-bread-slice', carbsPer100g: 56, unitName: 'unidade', unitWeight: 50, defaultQty: 1 },
            { name: 'Pão de forma', category: 'Cereais e Grãos', icon: 'fas fa-bread-slice', carbsPer100g: 52, unitName: 'fatia', unitWeight: 25, defaultQty: 2 },
            { name: 'Macarrão cozido', category: 'Cereais e Grãos', icon: 'fas fa-utensils', carbsPer100g: 28, unitName: 'xícara', unitWeight: 100, defaultQty: 1 },
            { name: 'Feijão carioca', category: 'Cereais e Grãos', icon: 'fas fa-seedling', carbsPer100g: 14, unitName: 'concha', unitWeight: 100, defaultQty: 1 },
            { name: 'Farofa', category: 'Cereais e Grãos', icon: 'fas fa-utensils', carbsPer100g: 84, unitName: 'colher de sopa', unitWeight: 25, defaultQty: 2 },
            { name: 'Aveia em flocos', category: 'Cereais e Grãos', icon: 'fas fa-utensils', carbsPer100g: 60, unitName: 'colher de sopa', unitWeight: 20, defaultQty: 2 },
            { name: 'Tapioca', category: 'Cereais e Grãos', icon: 'fas fa-utensils', carbsPer100g: 44, unitName: 'unidade', unitWeight: 50, defaultQty: 1 },
            
            // Raízes e Tubérculos
            { name: 'Batata inglesa cozida', category: 'Raízes e Tubérculos', icon: 'fas fa-utensils', carbsPer100g: 20, unitName: 'unidade média', unitWeight: 100, defaultQty: 1 },
            { name: 'Batata doce cozida', category: 'Raízes e Tubérculos', icon: 'fas fa-utensils', carbsPer100g: 20, unitName: 'pedaço', unitWeight: 100, defaultQty: 1 },
            { name: 'Mandioca cozida', category: 'Raízes e Tubérculos', icon: 'fas fa-utensils', carbsPer100g: 30, unitName: 'pedaço', unitWeight: 100, defaultQty: 1 },
            { name: 'Mandioquinha', category: 'Raízes e Tubérculos', icon: 'fas fa-utensils', carbsPer100g: 24, unitName: 'pedaço', unitWeight: 100, defaultQty: 1 },

            // Carnes e Ovos
            { name: 'Bife (Alcatra)', category: 'Carnes e Ovos', icon: 'fas fa-drumstick-bite', carbsPer100g: 0, unitName: 'unidade', unitWeight: 100, defaultQty: 1 },
            { name: 'Filé de Frango', category: 'Carnes e Ovos', icon: 'fas fa-drumstick-bite', carbsPer100g: 0, unitName: 'unidade', unitWeight: 100, defaultQty: 1 },
            { name: 'Ovo cozido', category: 'Carnes e Ovos', icon: 'fas fa-egg', carbsPer100g: 1.2, unitName: 'unidade', unitWeight: 50, defaultQty: 2 },

            // Legumes e Verduras
            { name: 'Alface', category: 'Verduras e Legumes', icon: 'fas fa-leaf', carbsPer100g: 2, unitName: 'prato', unitWeight: 50, defaultQty: 1 },
            { name: 'Tomate', category: 'Verduras e Legumes', icon: 'fas fa-apple-alt', carbsPer100g: 4, unitName: 'unidade média', unitWeight: 80, defaultQty: 1 },
            { name: 'Brócolis cozido', category: 'Verduras e Legumes', icon: 'fas fa-seedling', carbsPer100g: 7, unitName: 'xícara', unitWeight: 90, defaultQty: 1 },
            { name: 'Cenoura cozida', category: 'Verduras e Legumes', icon: 'fas fa-carrot', carbsPer100g: 8, unitName: 'unidade média', unitWeight: 90, defaultQty: 1 },

            // Frutas
            { name: 'Banana prata', category: 'Frutas', icon: 'fas fa-apple-alt', carbsPer100g: 26, unitName: 'unidade', unitWeight: 90, defaultQty: 1 },
            { name: 'Maçã gala', category: 'Frutas', icon: 'fas fa-apple-alt', carbsPer100g: 14, unitName: 'unidade', unitWeight: 150, defaultQty: 1 },
            { name: 'Mamão formosa', category: 'Frutas', icon: 'fas fa-apple-alt', carbsPer100g: 11, unitName: 'fatia', unitWeight: 100, defaultQty: 1 },
            { name: 'Laranja pera', category: 'Frutas', icon: 'fas fa-apple-alt', carbsPer100g: 12, unitName: 'unidade', unitWeight: 130, defaultQty: 1 },
        ];

        // --- LÓGICA DA APLICAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const foodGrid = document.getElementById('food-grid');
            const plateItems = document.getElementById('plate-items');
            const totalCarbsValue = document.getElementById('total-carbs-value');
            const clearPlateBtn = document.getElementById('clear-plate-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const searchInput = document.getElementById('search-food');
            const categoryTabsContainer = document.getElementById('category-tabs');
            const carbsLevelBar = document.getElementById('carbs-level-bar');
            const feedbackMessage = document.getElementById('feedback-message');
            const aiAnalysisSection = document.getElementById('ai-analysis-section');
            const analysisResult = document.getElementById('analysis-result');

            let plate = [];
            let currentCategory = 'Todos';

            const categories = ['Todos', ...new Set(foodDatabase.map(f => f.category))];

            function renderCategories() {
                categoryTabsContainer.innerHTML = '';
                categories.forEach(category => {
                    const tab = document.createElement('button');
                    tab.className = 'tab-btn';
                    tab.textContent = category;
                    if (category === currentCategory) tab.classList.add('active');
                    tab.addEventListener('click', () => {
                        currentCategory = category;
                        renderCategories();
                        renderFoodGrid();
                    });
                    categoryTabsContainer.appendChild(tab);
                });
            }

            function renderFoodGrid() {
                const searchTerm = searchInput.value.toLowerCase();
                foodGrid.innerHTML = '';
                const filteredFoods = foodDatabase.filter(food => 
                    (currentCategory === 'Todos' || food.category === currentCategory) &&
                    (food.name.toLowerCase().includes(searchTerm))
                );

                filteredFoods.forEach(food => {
                    const item = document.createElement('div');
                    item.className = 'food-item';
                    item.innerHTML = `<i class="${food.icon}"></i><span>${food.name}</span>`;
                    item.addEventListener('click', () => addFoodToPlate(food));
                    foodGrid.appendChild(item);
                });
            }

            function addFoodToPlate(food) {
                if (plate.find(item => item.name === food.name)) {
                    alert(`${food.name} já está no seu prato!`);
                    return;
                }
                const plateItem = { ...food, quantity: food.defaultQty, currentUnit: food.unitName };
                plate.push(plateItem);
                renderPlate();
            }

            function renderPlate() {
                if (plate.length === 0) {
                    plateItems.innerHTML = '<li id="empty-plate-message" style="background:none; border:none;">Seu prato está vazio.</li>';
                } else {
                    plateItems.innerHTML = '';
                    plate.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="item-details">
                                <span>${item.name}</span>
                                <input type="number" value="${item.quantity}" min="0" step="0.5" data-index="${index}">
                                <select data-index="${index}">
                                    <option value="${item.unitName}" ${item.currentUnit === item.unitName ? 'selected' : ''}>${item.unitName}</option>
                                    <option value="gramas" ${item.currentUnit === 'gramas' ? 'selected' : ''}>gramas</option>
                                </select>
                            </div>
                            <button class="remove-btn" data-index="${index}">&times;</button>
                        `;
                        plateItems.appendChild(li);
                    });
                }
                updateTotalCarbs();
            }

            function updateTotalCarbs() {
                const total = plate.reduce((sum, item) => {
                    const carbsPerGram = item.carbsPer100g / 100;
                    if (item.currentUnit === 'gramas') {
                        return sum + (item.quantity * carbsPerGram);
                    } else { // Medida caseira
                        return sum + (item.quantity * item.unitWeight * carbsPerGram);
                    }
                }, 0);
                totalCarbsValue.textContent = total.toFixed(1);
                
                const maxCarbs = 100; 
                const percentage = Math.min((total / maxCarbs) * 100, 100);
                carbsLevelBar.style.width = `${percentage}%`;

                if (total <= 40) {
                    carbsLevelBar.style.backgroundColor = 'var(--secondary-green)';
                    feedbackMessage.textContent = 'Refeição com baixo teor de carboidratos.';
                    feedbackMessage.style.color = 'var(--secondary-green)';
                } else if (total <= 70) {
                    carbsLevelBar.style.backgroundColor = '#ffc107';
                    feedbackMessage.textContent = 'Refeição com teor moderado de carboidratos.';
                    feedbackMessage.style.color = '#ffc107';
                } else {
                    carbsLevelBar.style.backgroundColor = '#dc3545';
                    feedbackMessage.textContent = 'Atenção! Refeição com alto teor de carboidratos.';
                    feedbackMessage.style.color = '#dc3545';
                }
                if (total === 0) feedbackMessage.textContent = '';
            }

            plateItems.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                    const index = e.target.dataset.index;
                    plate[index].quantity = parseFloat(e.target.value) || 0;
                    updateTotalCarbs();
                }
            });

            plateItems.addEventListener('change', (e) => {
                if (e.target.tagName === 'SELECT') {
                    const index = e.target.dataset.index;
                    const item = plate[index];
                    const newUnit = e.target.value;
                    const oldUnit = item.currentUnit;
                    
                    if (newUnit === oldUnit) return;

                    const input = e.target.previousElementSibling;
                    let currentQuantity = parseFloat(input.value);

                    if (newUnit === 'gramas' && oldUnit !== 'gramas') {
                        // Converter de unidade caseira para gramas
                        input.value = (currentQuantity * item.unitWeight).toFixed(1);
                    } else if (newUnit !== 'gramas' && oldUnit === 'gramas') {
                        // Converter de gramas para unidade caseira
                        input.value = (currentQuantity / item.unitWeight).toFixed(1);
                    }
                    
                    item.quantity = parseFloat(input.value);
                    item.currentUnit = newUnit;
                    updateTotalCarbs();
                }
            });

            plateItems.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = e.target.dataset.index;
                    plate.splice(index, 1);
                    renderPlate();
                }
            });
            
            clearPlateBtn.addEventListener('click', () => {
                plate = [];
                aiAnalysisSection.style.display = 'none';
                renderPlate();
            });
            
            searchInput.addEventListener('input', renderFoodGrid);

            async function handleAIAnalysis() {
                if (plate.length === 0) {
                    alert("Seu prato está vazio. Adicione alimentos antes de analisar.");
                    return;
                }

                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
                aiAnalysisSection.style.display = 'block';
                analysisResult.innerHTML = '<p>Aguarde, nossa IA está analisando sua refeição...</p>';

                const totalCarbs = totalCarbsValue.textContent;
                const foodList = plate.map(item => {
                    if (item.currentUnit === 'gramas') {
                        return `${item.quantity}g de ${item.name}`;
                    } else {
                        return `${item.quantity} ${item.unitName}(s) de ${item.name}`;
                    }
                }).join(', ');

                const prompt = `
                    Você é um assistente de nutrição virtual, especialista em diabetes, com um tom amigável e educativo.
                    Analise a seguinte refeição para uma pessoa que busca controlar a glicemia.
                    A refeição tem um total de ${totalCarbs}g de carboidratos e é composta por: ${foodList}.

                    Forneça uma análise curta e clara, formatada exatamente assim, sem usar markdown:
                    <h3>Análise Geral</h3>
                    <p>[Sua análise geral sobre a composição do prato em 1-2 frases. Seja encorajador.]</p>
                    <h3>Pontos Positivos</h3>
                    <p>[Destaque 1 ou 2 escolhas boas, como presença de fibras, proteínas, ou vegetais. Se não houver, mencione a importância deles.]</p>
                    <h3>Pontos de Atenção</h3>
                    <p>[Aponte 1 ou 2 pontos que poderiam ser melhorados, como excesso de carboidratos simples, frituras ou falta de salada. Use um tom gentil.]</p>
                    <h3>Sugestão da Nutri</h3>
                    <p>[Dê uma dica prática e fácil de aplicar para melhorar uma refeição parecida no futuro. Ex: "Da próxima vez, que tal trocar... por..." ou "Experimente adicionar..."]</p>
                `;

                try {
  const resp = await fetch("/api/analisar-refeicao", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const data = await resp.json();
  if (!resp.ok || !data.ok) {
    throw new Error(data.error || data.detail || "Falha na análise");
  }

  const analysisText = data.text || "Não foi possível obter uma análise. Tente novamente.";
  analysisResult.innerHTML = analysisText + `
    <div class="final-cta">
      <p>Lembre-se, esta é uma análise geral. Para um acompanhamento completo e personalizado:</p>
      <a href="https://wa.me/557781663201?text=Ol%C3%A1%2C%20analisei%20meu%20prato%20na%20calculadora%20e%20gostaria%20de%20agendar%20uma%20consulta."
         target="_blank" class="action-button" style="background-color: var(--primary-green); color: white;">
        Agende sua Consulta
      </a>
    </div>
  `;
} catch (error) {
  console.error("Erro na análise:", error);
  analysisResult.innerHTML = "<p>Ocorreu um erro ao analisar sua refeição. Tente novamente.</p>";
} finally {
  analyzeBtn.disabled = false;
  analyzeBtn.innerHTML = '<i class="fas fa-magic"></i> Analisar Refeição com IA';
}

            }

            analyzeBtn.addEventListener('click', handleAIAnalysis);

            // Inicialização
            renderCategories();
            renderFoodGrid();
        });
    </script>
</body>
</html>
